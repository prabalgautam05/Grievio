{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Admin Dashboard</title>

    <!-- Custom fonts for this template-->
    <link href="{%static 'vendor/fontawesome-free/css/all.min.css'%}" rel="stylesheet" type="text/css">
    <link
        href="{%static 'https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i'%}"
        rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="{%static 'css/sb-admin-2.min.css' %}" rel="stylesheet">

</head>

<body id="page-top">
    

    <!-- Page Wrapper -->
    <div id="wrapper" >

        <!-- Sidebar -->
        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

            <!-- Sidebar - Brand -->
            <a class="sidebar-brand d-flex align-items-center justify-content-center" href="/">
                <div class="sidebar-brand-icon rotate-n-15">
                    <i class="fas fa-laugh-wink"></i>
                </div>
                <div class="sidebar-brand-text mx-3">Admin Dashboard </div>
            </a>

            <!-- Divider -->
            <hr class="sidebar-divider my-0">

            <!-- Nav Item - Dashboard -->
            <li class="nav-item active">
                <a class="nav-link" href="/">
                    <i class="fas fa-fw fa-tachometer-alt"></i>
                    <span>Dashboard</span></a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Heading -->
            <div class="sidebar-heading">
                Interface
            </div>

            <!-- Divider -->
            <hr class="sidebar-divider">


            <!-- Nav Item - Tables -->
            <li class="nav-item">
                <a class="nav-link" href="/table" , target="_blank">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-table" viewBox="0 0 16 16">
                        <path
                            d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm15 2h-4v3h4zm0 4h-4v3h4zm0 4h-4v3h3a1 1 0 0 0 1-1zm-5 3v-3H6v3zm-5 0v-3H1v2a1 1 0 0 0 1 1zm-4-4h4V8H1zm0-4h4V4H1zm5-3v3h4V4zm4 4H6v3h4z" />
                    </svg>
                    <span>Tables</span></a>
            </li>

            <li class="nav-item">
                <a class="nav-link" href="/create_user">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-person-circle" viewBox="0 0 16 16">
                        <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0" />
                        <path fill-rule="evenodd"
                            d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1" />
                    </svg>
                    <span>create a new user</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/all_user">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-circle"
                        viewBox="0 0 16 16">
                        <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0" />
                        <path fill-rule="evenodd"
                            d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1" />
                    </svg>
                    <span>view/edit all users</span></a>
            </li>


            <li class="nav-item">
                <a class="nav-link" href="/accept_reject_complaint">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-emoji-sunglasses" viewBox="0 0 16 16">
                        <path
                            d="M4.968 9.75a.5.5 0 1 0-.866.5A4.5 4.5 0 0 0 8 12.5a4.5 4.5 0 0 0 3.898-2.25.5.5 0 1 0-.866-.5A3.5 3.5 0 0 1 8 11.5a3.5 3.5 0 0 1-3.032-1.75M7 5.116V5a1 1 0 0 0-1-1H3.28a1 1 0 0 0-.97 1.243l.311 1.242A2 2 0 0 0 4.561 8H5a2 2 0 0 0 1.994-1.839A3 3 0 0 1 8 6c.393 0 .74.064 1.006.161A2 2 0 0 0 11 8h.438a2 2 0 0 0 1.94-1.515l.311-1.242A1 1 0 0 0 12.72 4H10a1 1 0 0 0-1 1v.116A4.2 4.2 0 0 0 8 5c-.35 0-.69.04-1 .116" />
                        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-1 0A7 7 0 1 0 1 8a7 7 0 0 0 14 0" />
                    </svg>
                    <span>Accept/ Reject complaints</span></a>
            </li>

            




            <!-- Divider -->
            <hr class="sidebar-divider d-none d-md-block">

        </ul>
        <!-- End of Sidebar -->

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">

            <!-- Main Content -->
            <div id="content">

                <!-- Topbar -->
                <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">

                    <!-- Sidebar Toggle (Topbar) -->
                    <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                        <i class="fa fa-bars"></i>
                    </button>


                    <!-- Topbar Navbar -->
                    <ul class="navbar-nav ml-auto">
                        <div class="container">
                            <div class="row">
                                <div class="col">
                                    <div class="text-end container">
                                        <h1 class="h3 mb-0 fw-bolder text-gray-800  text-capitalize"> Welcome,{{ username }}
                                        {% if user.is_authenticated %}
                                        <a href="{% url 'logout' %}">Logout</a>
                                        {% endif %}</h1>
                                    </div>
                                </div>
                            </div>
                        </div>
                </nav>
                <!-- End of Topbar -->
                
                <!-- Begin Page Content -->
                <div class="container-fluid">

                    <!-- Page Heading -->
                    <div class="d-sm-flex align-items-center justify-content-between mb-4">
                        <h1 class="h1 mb-0 fw-bolder text-gray-800 text-center">Dashboard</h1>
                    </div>

                    


                    <!-- Total complaints -->
                    <div class="container">
                        <div class="row">
                            <!-- Total complaints -->
                            <div class="col-xl-12 col-md-12 mb-4">
                                <div class="card border-left-primary shadow h-100 py-2">
                                    <div class="card-body">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col mr-2">
                                                <div
                                                    class=" h1 text-center font-weight-bold text-primary text-uppercase mb-8">
                                                    <a href="/table" target="_blank">Total Complaints</a>
                                                   
                                                </div>
                                                <div class="text-center h1 mb-0 font-weight-bold text-gray-800"
                                                    id="totalComplaintsCount">0</div>
                                            </div>
                                            <div class="col-auto">
                                                <i class="fas fa-calendar fa-2x text-gray-300"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Resolved complaints -->
                            <div class="col-xl-2 col-md-6 mb-4">
                                <div class="card border-left-success shadow h-100 py-2">
                                    <div class="card-body">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col mr-2">
                                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                                    <a class="text-xs font-weight-bold text-success text-uppercase mb-1" href="/table/?status=Resolved" target="_blank">
                                                         Resolved Complaints </a></div>
                                                <div class="h5 mb-0 font-weight-bold text-gray-800"
                                                    id="resolvedComplaintsCount">0</div>
                                            </div>
                                            <div class="col-auto">
                                                <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pending complaints -->
                            <div class="col-xl-2 col-md-6 mb-4">
                                <div class="card border-left-warning shadow h-100 py-2">
                                    <div class="card-body">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col mr-2">
                                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                                <a  target="_blank" class="text-xs font-weight-bold text-warning text-uppercase mb-1" href="/table/?status=Pending">
                                                    Pending Complaints</a></div>
                                                <div class="h5 mb-0 font-weight-bold text-gray-800"
                                                    id="pendingComplaintsCount">0</div>
                                            </div>
                                            <div class="col-auto">
                                                <i class="fas fa-clock fa-2x text-gray-300"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- In-progress complaints -->
                            <div class="col-xl-2 col-md-6 mb-4">
                                <div class="card border-left-info shadow h-100 py-2">
                                    <div class="card-body">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col mr-2">
                                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                                 <a href="/table/?status=In+Progress" target="_blank" class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                                    In-progress Complaints</a></div>
                                                <div class="h5 mb-0 font-weight-bold text-gray-800"
                                                    id="inProgressComplaintsCount">0</div>
                                            </div>
                                            <div class="col-auto">
                                                <i class="fas fa-spinner  fa-2x text-gray-300"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Complaints allotted -->
                            <div class="col-xl-2 col-md-6 mb-4">
                                <div class="card border-left-secondary shadow h-100 py-2">
                                    <div class="card-body">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col mr-2">
                                                <div
                                                    class="text-xs font-weight-bold text-secondary text-uppercase mb-1">
                                                    <a href="/table/?status=Allotted" target="_blank" 
                                                    class="text-xs font-weight-bold text-secondary text-uppercase mb-1">
                                                    Complaints Allotted</a></div>
                                                <div class="h5 mb-0 font-weight-bold text-gray-800"
                                                    id="allottedComplaintsCount">0</div>
                                            </div>
                                            <div class="col-auto">
                                                <i class="fas fa-user fa-2x text-gray-300"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- rejected complaints -->
                            <div class="col-xl-2 col-md-6 mb-4">
                                <div class="card border-left-danger shadow h-100 py-2">
                                    <div class="card-body">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col mr-2">
                                                <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                                    <a href="/table/?status=Rejected" target="_blank" >
                                                    Complaints Rejected</a>
                                                </div>
                                                <div class="h5 mb-0 font-weight-bold text-gray-800"
                                                    id="rejectedComplaintsCount">0</div>
                                            </div>
                                            <div class="col-auto">
                                                <!-- Replace fa-calendar with fa-times-circle -->
                                                <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Accepted complaints -->
                            <div class="col-xl-2 col-md-6 mb-4">
                                <div class="card border-left-info  shadow h-100 py-2">
                                    <div class="card-body">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col mr-2">
                                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                                   <a href="/table/?status=Accepted" target="_blank" 
                                                   class="text-xs font-weight-bold text-info text-uppercase mb-1" > Accepted Complaints</a></div>
                                                <div class="h5 mb-0 font-weight-bold text-gray-800"
                                                    id="acceptedComplaintsCount">0</div>
                                            </div>
                                            <div class="col-auto">
                                                <i class="fas fa-thumbs-up fa-2x text-gray-300"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content Row -->

                    <div class="row">

                        <!-- Area Chart -->
                        <div class="col-xl-8 col-lg-7">
                            <div class="card shadow mb-4">
                                <!-- Card Header - Dropdown -->
                                <div
                                    class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary">Complaints Raised</h6>
                                </div>
                                <!-- Card Body -->
                                <div class="card-body">
                                    <div class="chart-area">
                                        <canvas id="complaintsRaisedChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>



                        <!-- Pie Chart -->
                        <div class="col-xl-4 col-lg-5">
                            <div class="card shadow mb-4">
                                <!-- Card Header - Dropdown -->
                                <div
                                    class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary">Complaints Dashboard</h6>
                                </div>
                                <!-- Card Body -->
                                <div class="card-body">
                                    <div class="chart-pie pt-4 pb-2">
                                        <canvas id="complaintsPieChart"></canvas>
                                    </div>
                                    <div class="mt-4 text-center small">
                                        <span class="mr-2">
                                            <i class="fas fa-circle text-warning"></i> Pending
                                        </span>
                                        <span class="mr-2">
                                            <i class="fas fa-circle text-success"></i> Resolved
                                        </span>
                                        <span class="mr-2">
                                            <i class="fas fa-circle text-info"></i> In Progress
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>




                    </div>
                    <!-- /.container-fluid -->

                </div>
                <!-- End of Main Content -->

                <!-- Footer -->
                <footer class="sticky-footer bg-white">
                    <div class="container my-auto">

                    </div>
                </footer>
                <!-- End of Footer -->

            </div>
            <!-- End of Content Wrapper -->

        </div>
        <!-- End of Page Wrapper -->

        <!-- Scroll to Top Button-->
        <a class="scroll-to-top rounded" href="#page-top">
            <i class="fas fa-angle-up"></i>
        </a>

        <!-- Logout Modal-->

        <!-- Bootstrap core JavaScript-->
        <script src="{% static 'vendor/jquery/jquery.min.js' %}"></script>
        <script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>

        <!-- Core plugin JavaScript-->
        <script src="{% static 'vendor/jquery-easing/jquery.easing.min.js' %}"></script>

        <!-- Custom scripts for all pages-->
        <script src="{% static 'js/sb-admin-2.min.js' %}"></script>

        <!-- Page level plugins -->
        <script src="{% static 'vendor/chart.js/Chart.min.js' %}"></script>

        <!-- Page level custom scripts -->
        <script src="{% static 'js/demo/chart-area-demo.js' %}"></script>
        <script src="{% static 'js/demo/chart-pie-demo.js' %}"></script>

        <!-- Bootstrap JS and Font Awesome -->
        <script src="https://kit.fontawesome.com/a076d05399.js"></script>
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>

        <script>
            // Function to fetch complaints data from API and update the pie chart
            function fetchComplaintsDataAndUpdateChart() {
                fetch('api/complaints/')
                    .then(response => response.json())
                    .then(data => {
                        // Calculate counts for all different complaint statuses
                        const pendingCount = data.filter(complaint => complaint.status === 'Pending').length;
                        const resolvedCount = data.filter(complaint => complaint.status === 'Resolved').length;
                        const inProgressCount = data.filter(complaint => complaint.status === 'In Progress').length;
                        const acceptedCount = data.filter(complaint => complaint.status === 'Accepted').length;
                        const allottedCount = data.filter(complaint => complaint.status === 'Allotted').length;
                        const rejectedCount = data.filter(complaint => complaint.status === 'Rejected').length;

                        // Update pie chart with the counts
                        updatePieChart(pendingCount, resolvedCount, inProgressCount, acceptedCount, allottedCount, rejectedCount);

                        // Calculate total number of complaints
                        const totalComplaints = data.length;

                        // Update HTML elements with the fetched data
                        document.getElementById('totalComplaintsCount').textContent = totalComplaints;
                        document.getElementById('resolvedComplaintsCount').textContent = resolvedCount;
                        document.getElementById('pendingComplaintsCount').textContent = pendingCount;
                        document.getElementById('inProgressComplaintsCount').textContent = inProgressCount;
                        document.getElementById('acceptedComplaintsCount').textContent = acceptedCount;
                        document.getElementById('allottedComplaintsCount').textContent = allottedCount;
                        document.getElementById('rejectedComplaintsCount').textContent = rejectedCount;
                    })
                    .catch(error => console.error('Error fetching data:', error));
            }



            // Function to update the pie chart with provided counts
            function updatePieChart(pendingCount, resolvedCount, inProgressCount, acceptedCount, allottedCount, rejectedCount) {
                const ctx = document.getElementById('complaintsPieChart').getContext('2d');
                const myPieChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Pending', 'Resolved', 'In Progress', 'Accepted', 'Allotted', 'rejected'],
                        datasets: [{
                            data: [pendingCount, resolvedCount, inProgressCount, acceptedCount, allottedCount, rejectedCount],
                            backgroundColor: ['#ffc107', '#28a745', '#17a2b8', '#007bff', '#6c757d', '#ff0000'],
                            hoverBackgroundColor: ['#ffd300', '#218838', '#138496', '#0056b3', '#5a6268', '#ff0000'],
                            hoverBorderColor: 'rgba(234, 236, 244, 1)',
                        }],
                    },
                    options: {
                        maintainAspectRatio: false,
                        tooltips: {
                            backgroundColor: 'rgb(255,255,255)',
                            bodyFontColor: '#858796',
                            borderColor: '#dddfeb',
                            borderWidth: 1,
                            xPadding: 15,
                            yPadding: 15,
                            displayColors: false,
                            caretPadding: 10,
                        },
                        legend: {
                            display: false,
                        },
                        cutoutPercentage: 80,
                    },
                });
            }

            // Function to fetch complaints raised data from API and update the area chart
            function fetchComplaintsRaisedDataAndUpdateChart() {
                fetch('api/complaints/')
                    .then(response => response.json())
                    .then(data => {
                        // Extract dates and counts for complaints raised
                        const dates = data.map(complaint => complaint.raised_at.split('T')[0]);
                        const counts = {};

                        // Count complaints raised per date
                        dates.forEach(date => {
                            counts[date] = (counts[date] || 0) + 1;
                        });

                        // Prepare data for chart
                        const labels = Object.keys(counts);
                        const values = Object.values(counts);

                        // Update area chart with the data
                        updateAreaChart(labels, values);
                    })
                    .catch(error => console.error('Error fetching data:', error));
            }

            // Function to update the area chart with provided data
            function updateAreaChart(labels, values) {
                const ctx = document.getElementById('complaintsRaisedChart').getContext('2d');
                const myAreaChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Complaints Raised',
                            lineTension: 0.3,
                            backgroundColor: 'rgba(78, 115, 223, 0.05)',
                            borderColor: 'rgba(78, 115, 223, 1)',
                            pointRadius: 3,
                            pointBackgroundColor: 'rgba(78, 115, 223, 1)',
                            pointBorderColor: 'rgba(78, 115, 223, 1)',
                            pointHoverRadius: 3,
                            pointHoverBackgroundColor: 'rgba(78, 115, 223, 1)',
                            pointHoverBorderColor: 'rgba(78, 115, 223, 1)',
                            pointHitRadius: 10,
                            pointBorderWidth: 2,
                            data: values,
                        }],
                    },
                    options: {
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                left: 10,
                                right: 25,
                                top: 25,
                                bottom: 0
                            }
                        },
                        scales: {
                            xAxes: [{
                                time: {
                                    unit: 'date'
                                },
                                gridLines: {
                                    display: false,
                                    drawBorder: false
                                },
                                ticks: {
                                    maxTicksLimit: 7
                                }
                            }],
                            yAxes: [{
                                ticks: {
                                    maxTicksLimit: 5,
                                    padding: 10,
                                    // Include a dollar sign in the ticks
                                    callback: function (value, index, values) {
                                        return value;
                                    }
                                },
                                gridLines: {
                                    color: 'rgb(234, 236, 244)',
                                    zeroLineColor: 'rgb(234, 236, 244)',
                                    drawBorder: false,
                                    borderDash: [2],
                                    zeroLineBorderDash: [2]
                                }
                            }],
                        },
                        legend: {
                            display: false
                        },
                        tooltips: {
                            backgroundColor: 'rgb(255,255,255)',
                            bodyFontColor: '#858796',
                            titleMarginBottom: 10,
                            titleFontColor: '#6e707e',
                            titleFontSize: 14,
                            borderColor: '#dddfeb',
                            borderWidth: 1,
                            xPadding: 15,
                            yPadding: 15,
                            displayColors: false,
                            intersect: false,
                            mode: 'index',
                            caretPadding: 10,
                        }
                    }
                });
            }

            // Call fetchComplaintsDataAndUpdateChart function when the page loads
            window.onload = function () {
                fetchComplaintsDataAndUpdateChart();
                fetchComplaintsRaisedDataAndUpdateChart();
            };
        </script>



</body>

</html>